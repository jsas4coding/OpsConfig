#!/usr/bin/env bash
# =============================================================================
# OPSCONFIG BASH CUSTOMIZATIONS
# =============================================================================
# Server-optimized bash configuration for remote environments.
# Designed for GCP, AWS, and other cloud servers.
# =============================================================================

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================

export VISUAL='nvim'
export EDITOR='nvim'
export GIT_EDITOR='nvim'

# OpsConfig type detection
export OPSCONFIG_TYPE="${OPSCONFIG_TYPE:-servers}"

# =============================================================================
# DISTRIBUTION (Ubuntu only)
# =============================================================================

export OPSCONFIG_DISTRO="ubuntu"

# =============================================================================
# LOGGING FUNCTIONS (ASCII-compatible, no Nerd Fonts required)
# =============================================================================

log_info() {
  echo -e "\033[1;34m[INFO]\033[0m $1"
}

log_success() {
  echo -e "\033[1;32m[ OK ]\033[0m $1"
}

log_warning() {
  echo -e "\033[1;33m[WARN]\033[0m $1"
}

log_error() {
  echo -e "\033[1;31m[ERR!]\033[0m $1"
}

# Legacy alias for compatibility
echo_log() {
  log_info "$1"
}

# =============================================================================
# ALIASES - General
# =============================================================================

alias c='clear'
alias quit='exit'
alias e='exit'
alias q='exit'

# =============================================================================
# SYSTEM UPDATE FUNCTION
# =============================================================================
# Wrapper for the standalone update script.
# Run 'update --help' for all options including server cleanup.
# =============================================================================

update_system() {
  local update_script="${HOME}/.opsconfig/update"

  if [[ -x "${update_script}" ]]; then
    "${update_script}" "$@"
  else
    log_error "Update script not found at ${update_script}"
    log_info "Run the OpsConfig installer to fix this."
    return 1
  fi
}

alias upgrade="update_system"
alias u="update_system"
alias uc="update_system --cleanup-only"

#######################################################################################################################
## FileSystem
#######################################################################################################################
alias ..='cd ..'
alias ...='cd ../..'
alias ....="cd ../../.."
alias .....="cd ../../../.."

alias l='ls -AGlhSr --color=always'
alias ls='ls -AGlhSr --color=always'
alias ll='ls -AGlhSr --color=always'
alias lt='ls --human-readable --size -1 -S --classify'

# =============================================================================
# VIM/NEOVIM ALIASES
# =============================================================================
# Use wrapper script that activates Python environment for pynvim support
NEOVIM_WRAPPER="/var/scripts/neovim"
if [[ -x ${NEOVIM_WRAPPER} ]]; then
  alias v="${NEOVIM_WRAPPER}"
  alias vi="${NEOVIM_WRAPPER}"
  alias vim="${NEOVIM_WRAPPER}"
  alias neovim="${NEOVIM_WRAPPER}"
  alias nano="${NEOVIM_WRAPPER}"
else
  # Fallback to direct nvim if wrapper not installed
  alias v='nvim'
  alias vi='nvim'
  alias vim='nvim'
  alias neovim='nvim'
  alias nano='nvim'
fi

# =============================================================================
# SHELL OPTIONS (Enhanced bash experience)
# =============================================================================

# History settings
HISTCONTROL=ignoreboth:erasedups # Ignore duplicates and commands starting with space
HISTSIZE=10000                   # Number of commands in memory
HISTFILESIZE=20000               # Number of commands in history file
HISTTIMEFORMAT="%F %T "          # Add timestamps to history

# Security: filter sensitive commands from history
HISTIGNORE='*password*:*passwd*:*secret*:*token*:*api_key*:*apikey*:*auth*:*credential*'
HISTIGNORE+=':export *KEY*:export *SECRET*:export *TOKEN*:export *PASS*:export *AUTH*'
HISTIGNORE+=':*mysql*-p*:*psql*-W*:*mongo*--password*:curl*-u *:wget*--password*'
HISTIGNORE+=':*AWS_*=*:*GCP_*=*:*AZURE_*=*:ssh-add *:*id_rsa*:*id_ed25519*'

# Shell options for better experience
shopt -s histappend   # Append to history instead of overwriting
shopt -s cdspell      # Auto-correct minor cd typos
shopt -s dirspell     # Auto-correct directory spelling in completion
shopt -s autocd       # Change to directory without typing cd
shopt -s globstar     # Enable ** for recursive globbing
shopt -s checkwinsize # Update LINES and COLUMNS after each command
shopt -s cmdhist      # Save multi-line commands as single history entry
shopt -s nocaseglob   # Case-insensitive globbing

# =============================================================================
# PYTHON ENVIRONMENT (Disabled - use neovim wrapper instead)
# =============================================================================
# Python environment is now activated only when running Neovim via the wrapper
# script at /var/scripts/neovim. This prevents polluting the global shell.
# To manually activate: source ~/.config/opsconfig/lib/python/bin/activate

#######################################################################################################################
## Link & Unlink
#######################################################################################################################
alias unlink-all='find . -type l -exec unlink {} \;'
alias sunlink-all='sudo find . -type l -exec unlink {} \;'

#######################################################################################################################
## Software
#######################################################################################################################
alias reload='RELOAD=1 source ~/.bashrc'
alias refresh-keys='sudo apt-key adv --refresh-keys --keyserver keyserver.ubuntu.com'

# =============================================================================
# NODE.JS VERSION MANAGER (fnm/nvm auto-detection)
# =============================================================================
# Supports both fnm (Fast Node Manager) and nvm with automatic detection.
# fnm is preferred for better performance (Rust-based, faster shell startup).

_load_node_manager() {
  # Try fnm first (faster, Rust-based)
  if command -v fnm &>/dev/null; then
    eval "$(fnm env --use-on-cd)"
    return 0
  fi

  # Check fnm in common locations
  if [[ -x "${HOME}/.local/share/fnm/fnm" ]]; then
    export PATH="${HOME}/.local/share/fnm:${PATH}"
    eval "$(fnm env --use-on-cd)"
    return 0
  fi

  # Fallback to nvm if fnm not available
  export NVM_DIR="${HOME}/.nvm"
  if [[ -s "${NVM_DIR}/nvm.sh" ]]; then
    \. "${NVM_DIR}/nvm.sh"
    [[ -s "${NVM_DIR}/bash_completion" ]] && \. "${NVM_DIR}/bash_completion"
    return 0
  fi

  return 1
}

_load_node_manager

#######################################################################################################################
## FZF
#######################################################################################################################
[ -f ~/.fzf.bash ] && source ~/.fzf.bash

# =============================================================================
# CLIPBOARD CONFIGURATION (SSH/TMUX/WezTerm/Gnome Terminal compatible)
# =============================================================================
# Enhanced clipboard function that works across different environments:
# - Local terminals (uses system clipboard tools)
# - SSH sessions (uses OSC52 escape sequence)
# - TMUX (passthrough enabled for OSC52)
# - WezTerm, Gnome Terminal, and other modern terminals

function remote-copy() {
  local content

  if [[ $# -eq 0 ]]; then
    # Read from stdin
    content=$(cat)
  else
    # Use arguments as content
    content="$*"
  fi

  # Detect environment and use appropriate method
  local is_ssh=false
  local is_tmux=false
  local is_wezterm=false

  [[ -n ${SSH_CONNECTION:-} ]] || [[ -n ${SSH_CLIENT:-} ]] || [[ -n ${SSH_TTY:-} ]] && is_ssh=true
  [[ -n ${TMUX:-} ]] && is_tmux=true
  [[ -n ${WEZTERM_PANE:-} ]] && is_wezterm=true

  # SSH sessions: Always use OSC52 (works with TMUX passthrough)
  if [[ ${is_ssh} == true ]]; then
    _osc52_copy "$content"
    return
  fi

  # Local session: Try system clipboard tools in order of preference
  # Wayland
  if command -v wl-copy &>/dev/null && [[ -n ${WAYLAND_DISPLAY:-} ]]; then
    printf '%s' "$content" | wl-copy
    return
  fi

  # X11
  if command -v xclip &>/dev/null && [[ -n ${DISPLAY:-} ]]; then
    printf '%s' "$content" | xclip -in -selection clipboard
    return
  fi

  if command -v xsel &>/dev/null && [[ -n ${DISPLAY:-} ]]; then
    printf '%s' "$content" | xsel --clipboard --input
    return
  fi

  # macOS
  if command -v pbcopy &>/dev/null; then
    printf '%s' "$content" | pbcopy
    return
  fi

  # Fallback to OSC52 for any terminal that supports it
  _osc52_copy "$content"
}

# OSC52 escape sequence for clipboard (works in most modern terminals)
function _osc52_copy() {
  local content="$1"
  local encoded
  encoded=$(printf '%s' "$content" | base64 | tr -d '\r\n')

  # Use appropriate escape sequence based on terminal
  if [[ -n ${TMUX:-} ]]; then
    # TMUX requires passthrough escape
    printf '\033Ptmux;\033\033]52;c;%s\a\033\\' "$encoded" >&2
  else
    # Standard OSC52
    printf '\033]52;c;%s\a' "$encoded" >&2
  fi
}

# Aliases for easy clipboard operations
alias rclip='remote-copy'
alias clip='remote-copy'
alias copy='remote-copy'

# =============================================================================
# SSH AGENT (Auto-start for key management)
# =============================================================================
# Automatically start ssh-agent if not running
if [[ -z ${SSH_AUTH_SOCK:-} ]]; then
  eval "$(ssh-agent -s)" &>/dev/null
fi

#######################################################################################################################
## PS1
#######################################################################################################################
#######################################################################################################################
source "${HOME}/.bash_ps1"
